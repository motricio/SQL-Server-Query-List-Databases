-- Obtener los procedimientos almacenados de cada base de datos de la Instancia


USE master;

DECLARE @DB_NAME AS VARCHAR(100)='';
DECLARE @MEMBER_OF AS VARCHAR(100)='';
DECLARE @TSQL AS NVARCHAR(1000)='';

DECLARE @TBL_SP AS TABLE
	(
		[DB_NAME] varchar(100),
		[NAME] varchar(100),
		[CREATE_DATE] DATETIME,
		[MODIFY_DATE] DATETIME
	);

DECLARE CURSOR_1 CURSOR
    FOR
	SELECT DISTINCT
		DB_NAME(A.DATABASE_ID) AS [DATABASE NAME]
				FROM SYS.MASTER_FILES A
		INNER JOIN SYSDATABASES B 
		ON (A.DATABASE_ID = B.DBID)
		WHERE A.DATABASE_ID>4
		AND A.PHYSICAL_NAME NOT LIKE '%.LDF%'
		--AND B.status=65544
		ORDER BY 
		DB_NAME(A.DATABASE_ID)

OPEN CURSOR_1;
FETCH NEXT FROM CURSOR_1 INTO @DB_NAME
WHILE @@FETCH_STATUS = 0
    BEGIN
		SET @TSQL='USE [' + @DB_NAME+'];';
		SET @TSQL = @TSQL+
		'SELECT 
			'''+@DB_NAME+''' AS [DB_NAME], [NAME], [CREATE_DATE], [MODIFY_DATE]
		FROM sys.objects
		WHERE type = ''P''
		ORDER BY [DB_NAME]
		'
		print @TSQL;
		INSERT INTO @TBL_SP([DB_NAME], [NAME], [CREATE_DATE], [MODIFY_DATE])
		EXECUTE sp_executesql @TSQL;
		--print @TSQL;

		FETCH NEXT FROM CURSOR_1 INTO @DB_NAME
    END
CLOSE CURSOR_1;
DEALLOCATE CURSOR_1;

SELECT
	[A].[DB_NAME],
	[A].[NAME] AS [SP_NAME],
	[A].[MODIFY_DATE],
	[A].[CREATE_DATE]	
FROM 
	@TBL_SP AS A
WHERE [A].[MODIFY_DATE] > '2016-03-27 11:59:00'
AND [A].[DB_NAME] not in ('ReportServer')
ORDER BY 
	[A].[MODIFY_DATE] DESC
--	[A].[CREATE_DATE] DESC

GO