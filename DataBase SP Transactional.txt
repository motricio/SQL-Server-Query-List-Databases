-- Obtener los procedimientos almacenados de cada base de datos de la Instancia
-- Que estan diseñados para soportar concistencia Transaccional

USE master;

DECLARE @DB_NAME AS VARCHAR(50)='';
DECLARE @TSQL AS NVARCHAR(1000)='';

DECLARE @TBL_SP_AUDIT AS TABLE
	(
		[SP_NAME] varchar(50),
		[DB_NAME] varchar(50),
		[DATE_CREATED] DATETIME,
		[DATE_MODIFIED] DATETIME
	);

DECLARE CURSOR_1 CURSOR
    FOR
	SELECT DISTINCT
		DB_NAME(A.DATABASE_ID) AS [DATABASE NAME]
				FROM SYS.MASTER_FILES A
		INNER JOIN SYSDATABASES B 
		ON (A.DATABASE_ID = B.DBID)
		WHERE A.DATABASE_ID>4
		AND A.PHYSICAL_NAME NOT LIKE '%.LDF%'
		AND DB_NAME(A.DATABASE_ID) <> 'ReportServer'
		--AND B.status=65544
		ORDER BY 
		DB_NAME(A.DATABASE_ID)

OPEN CURSOR_1;
FETCH NEXT FROM CURSOR_1 INTO @DB_NAME
WHILE @@FETCH_STATUS = 0
    BEGIN
		SET @TSQL='USE ' + @DB_NAME+';';
		SET @TSQL = @TSQL+
		'
		SELECT 
		O.NAME, 
		'''+@DB_NAME+''' AS [DB_NAME],
		O.CREATE_DATE, 
		O.MODIFY_DATE
		FROM SYS.SQL_MODULES M 
		INNER JOIN SYS.OBJECTS O 
		ON M.OBJECT_ID=O.OBJECT_ID
		WHERE 
		M.DEFINITION LIKE ''%COMMIT%''
		OR M.DEFINITION LIKE ''%BEGIN TRANSACTION%''
		OR M.DEFINITION LIKE ''%TRY%''
		OR M.DEFINITION LIKE ''%CATCH%''
		ORDER BY O.NAME
		'
		INSERT INTO @TBL_SP_AUDIT([SP_NAME],[DB_NAME],[DATE_CREATED],[DATE_MODIFIED])
		EXECUTE sp_executesql @TSQL;

		FETCH NEXT FROM CURSOR_1 INTO @DB_NAME
    END
CLOSE CURSOR_1;
DEALLOCATE CURSOR_1;

SELECT
	[A].[SP_NAME],
	[A].[DB_NAME],
	[A].[DATE_CREATED],
	[A].[DATE_MODIFIED]
FROM 
	@TBL_SP_AUDIT AS A
ORDER BY 
	[A].[DB_NAME]
GO